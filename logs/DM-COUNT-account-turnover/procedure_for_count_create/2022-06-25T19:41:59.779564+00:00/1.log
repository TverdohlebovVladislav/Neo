[2022-06-26 21:17:12,315] {taskinstance.py:1032} INFO - Dependencies all met for <TaskInstance: DM-COUNT-account-turnover.procedure_for_count_create scheduled__2022-06-25T19:41:59.779564+00:00 [queued]>
[2022-06-26 21:17:12,332] {taskinstance.py:1032} INFO - Dependencies all met for <TaskInstance: DM-COUNT-account-turnover.procedure_for_count_create scheduled__2022-06-25T19:41:59.779564+00:00 [queued]>
[2022-06-26 21:17:12,332] {taskinstance.py:1238} INFO - 
--------------------------------------------------------------------------------
[2022-06-26 21:17:12,333] {taskinstance.py:1239} INFO - Starting attempt 1 of 2
[2022-06-26 21:17:12,333] {taskinstance.py:1240} INFO - 
--------------------------------------------------------------------------------
[2022-06-26 21:17:12,348] {taskinstance.py:1259} INFO - Executing <Task(PostgresOperator): procedure_for_count_create> on 2022-06-25 19:41:59.779564+00:00
[2022-06-26 21:17:12,352] {standard_task_runner.py:52} INFO - Started process 87 to run task
[2022-06-26 21:17:12,360] {standard_task_runner.py:76} INFO - Running: ['***', 'tasks', 'run', 'DM-COUNT-account-turnover', 'procedure_for_count_create', 'scheduled__2022-06-25T19:41:59.779564+00:00', '--job-id', '1420', '--raw', '--subdir', 'DAGS_FOLDER/dm_fill_account_turnover.py', '--cfg-path', '/tmp/tmptxm9gzqe', '--error-file', '/tmp/tmpyn7wbxet']
[2022-06-26 21:17:12,361] {standard_task_runner.py:77} INFO - Job 1420: Subtask procedure_for_count_create
[2022-06-26 21:17:12,699] {logging_mixin.py:109} INFO - Running <TaskInstance: DM-COUNT-account-turnover.procedure_for_count_create scheduled__2022-06-25T19:41:59.779564+00:00 [running]> on host 8dd6b2950340
[2022-06-26 21:17:13,034] {taskinstance.py:1426} INFO - Exporting the following env vars:
AIRFLOW_CTX_DAG_OWNER=***
AIRFLOW_CTX_DAG_ID=DM-COUNT-account-turnover
AIRFLOW_CTX_TASK_ID=procedure_for_count_create
AIRFLOW_CTX_EXECUTION_DATE=2022-06-25T19:41:59.779564+00:00
AIRFLOW_CTX_DAG_RUN_ID=scheduled__2022-06-25T19:41:59.779564+00:00
[2022-06-26 21:17:13,065] {base.py:79} INFO - Using connection to: id: postgres. Host: postgres, Port: 5432, Schema: postgres, Login: ***, Password: ***, extra: {}
[2022-06-26 21:17:13,085] {dbapi.py:225} INFO - Running statement: create or replace procedure ds.fill_account_turnover_f (
   i_OnDate date
)
language plpgsql    
as $$
declare
	v_RowCount int;
begin
	
	call logs.writelog( '[BEGIN] fill(i_OnDate => date ''' 
         || to_char(i_OnDate, 'yyyy-mm-dd') 
         || ''');', 1
       );
    
    call logs.writelog( 'delete on_date = ' 
         || to_char(i_OnDate, 'yyyy-mm-dd'), 1
       );
	   
    delete
      from dm.dm_account_turnover_f f
     where f.on_date = i_OnDate;
   
    call logs.writelog('insert', 1);
	
    insert
      into dm.dm_account_turnover_f
           ( on_date
           , account_rk
           , credit_amount
           , credit_amount_rub
           , debet_amount
           , debet_amount_rub
           )
    with wt_turn as
    ( select p.credit_account_rk                  as account_rk
           , p.credit_amount                      as credit_amount
           , p.credit_amount * nullif(er.reduced_cource, 1)         as credit_amount_rub
           , cast(null as numeric)                 as debet_amount
           , cast(null as numeric)                 as debet_amount_rub
        from ds.ft_posting_f p
        join ds.md_account_d a
          on a.account_rk = p.credit_account_rk
        left
        join ds.md_exchange_rate_d er
          on er.currency_rk = a.currency_rk
         and i_OnDate between er.data_actual_date   and er.data_actual_end_date
       where p.oper_date = i_OnDate
         and i_OnDate           between a.data_actual_date    and a.data_actual_end_date
         and a.data_actual_date between date_trunc('month', i_OnDate) and (date_trunc('MONTH', i_OnDate) + INTERVAL '1 MONTH - 1 day')
       union all
      select p.debet_account_rk                   as account_rk
           , cast(null as numeric)                 as credit_amount
           , cast(null as numeric)                 as credit_amount_rub
           , p.debet_amount                       as debet_amount
           , p.debet_amount * nullif(er.reduced_cource, 1)          as debet_amount_rub
        from ds.ft_posting_f p
        join ds.md_account_d a
          on a.account_rk = p.debet_account_rk
        left 
        join ds.md_exchange_rate_d er
          on er.currency_rk = a.currency_rk
         and i_OnDate between er.data_actual_date and er.data_actual_end_date
       where p.oper_date = i_OnDate
         and i_OnDate           between a.data_actual_date and a.data_actual_end_date
         and a.data_actual_date between date_trunc('month', i_OnDate) and (date_trunc('MONTH', i_OnDate) + INTERVAL '1 MONTH - 1 day')
    )
    select i_OnDate                               as on_date
         , t.account_rk
         , sum(t.credit_amount)                   as credit_amount
         , sum(t.credit_amount_rub)               as credit_amount_rub
         , sum(t.debet_amount)                    as debet_amount
         , sum(t.debet_amount_rub)                as debet_amount_rub
      from wt_turn t
     group by t.account_rk;
	 
	GET DIAGNOSTICS v_RowCount = ROW_COUNT;
    call logs.writelog('[END] inserted ' || to_char(v_RowCount,'FM99999999') || ' rows.', 1);

    commit;
	
end;$$, parameters: None
[2022-06-26 21:17:13,196] {taskinstance.py:1277} INFO - Marking task as SUCCESS. dag_id=DM-COUNT-account-turnover, task_id=procedure_for_count_create, execution_date=20220625T194159, start_date=20220626T211712, end_date=20220626T211713
[2022-06-26 21:17:13,283] {local_task_job.py:154} INFO - Task exited with return code 0
[2022-06-26 21:17:13,500] {local_task_job.py:264} INFO - 0 downstream tasks scheduled from follow-on schedule check
